---
title: "Tècniques Avançades en Mineria de Dades. Pràctica 1"
output:
  html_document:
    df_print: paged
---

## 1. Preparació del DataFrame

Importar llibreries:
```{r}
library(rJava)
library(foreign)
library(rsubgroup)
```

### 1.1. Lectura del CSV

Llegir el CSV amb la informació dels crims comesos a Los Ángeles:
```{r}
crimes = read.csv2("Crime_Data_from_2020_to_Present.csv", header = TRUE, sep = ",", stringsAsFactors = TRUE)
```


### 1.2. Neteja de dades

Convertir columnes a factors, elegir intérvals per a columnes numèriques, fer conversions de format i crear noves columnes amb dades interessants a tenir en compte més tard:
```{r}
# Convertir columnes amb un id a factors
factor_cols = c("Crm.Cd", "Crm.Cd.2", "Crm.Cd.3", "Crm.Cd.4", "Weapon.Used.Cd", "Rpt.Dist.No", "Premis.Cd")
for(f in factor_cols){
  crimes[[f]] = as.factor(crimes[[f]])
}

# Agafar hores de 4 en 4 i convertir a factor
interval = 4
hores = floor(floor(crimes$TIME.OCC/100)/interval)*interval
for (h in seq(interval, 24, by=interval)){
  hores[hores == h - interval] = paste((h-interval), "-", h)
}
crimes$TIME.OCC2 = as.factor(hores)

# Edat de 10 en 10
interval = 10
edats = floor(crimes$Vict.Age/interval)*interval
for (e in seq(interval, 70, by=interval)){
  edats[edats == e - interval] = paste((e-interval), "-", e)
}
edats[edats > 60] = "+60"
crimes$Vict.Age2 = as.factor(edats)

# Columnes amb data
data_cols = c("DATE.OCC", "Date.Rptd")
for(f in data_cols){
  crimes[[f]] = strptime(crimes[[f]], format = "%m/%d/%Y %H:%M:%S %p")
}

# Mes en què s'ha produït el crim
crimes$Month.Occ = as.factor(strftime(crimes$DATE.OCC, format = "%B"))

# Dia de la setmana en què s'ha produït el crim
crimes$Weekday.Occ = as.factor(strftime(crimes$DATE.OCC, format = "%A"))

# Dies que han passat des que es comet el crim fins que es reporta
diff = as.integer(mapply(julian, crimes$Date.Rptd, crimes$DATE.OCC))
diff_c = diff
diff_c[diff > 365] = "more than 1 year"
diff_c[diff <= 365] = "1 year"
diff_c[diff <= 30] = "1 month"
diff_c[diff <= 7] = "1 week"
diff_c[diff <= 0] = "same day"
crimes$Diff.Occ.Rep = as.factor(diff_c)

```

<br>
Elegir les columnes del nou dataframe i canviar els noms. 
No s'utilitzen el tercer i quart crims comesos, degut a la seva poca freqüència (màxim 1000).
```{r}
crims = crimes[, c("Crm.Cd", "Crm.Cd.2",                                                # Crims
                             "TIME.OCC2", "Month.Occ", "Weekday.Occ", "Diff.Occ.Rep",   # Hores i dates
                             "AREA.NAME", "Rpt.Dist.No", "Premis.Desc",                 # Localització
                             "Vict.Age2", "Vict.Sex", "Vict.Descent",                   # Víctima
                             "Weapon.Desc", "Status"                                    # Altres
                             )
                         ]
colnames(crims) <- c('Crim','Crim.2',                                                   # Crims
                     "Hora", "Mes", "Dia.Setmana", "Dif.Oc.Rep",                        # Hores i dates
                     "Area", "Districte", "Lloc",                                       # Localització
                     "Vict.Edat", "Vict.Sexe", "Vict.Descent",                          # Víctima
                     "Arma", "Estat"                                                    # Altres
                     )
```

### 1.3. Visualització de dades

Tipus de les columnes:
```{r}
str(crims)
```

<br>
Primers crims del dataframe:
```{r}
head(crims)
```

#### Vista de diferents camps

<br>
Crims ordenats per freqüència:
```{r}
as.data.frame(sort(table(crimes$Crm.Cd.Desc), decreasing = TRUE))
```

<br>
2n crim ordenat per freqüència:
```{r}
as.data.frame(sort(table(crimes$Crm.Cd.2), decreasing = TRUE))
```

<br>
Àrees ordenades per freqüència:
```{r}
as.data.frame(sort(table(crimes$AREA.NAME), decreasing = TRUE))
```

<br>
Armes ordenades per freqüència:
```{r}
as.data.frame(sort(table(crimes$Weapon.Desc), decreasing = TRUE))
```

<br>
<br>

## 2. Descobriment de subgrups

### Funció DiscoverSubgroups

* **method** (per defecte *sdmap*): 
  - Beam-Search *beam*
  - BSD *bsd*
  - SD-Map *sdmap*
  - SD-Map enabling internal disjunctions *sdmap-dis*
  
* **qf** (per defecte *ps*): 
  - Adjusted Residuals *ares*
  - Binomial Test *bin*
  - Chi-Square Test *chi2*
  - Gain *gain*
  - Lift *lift*
  - Piatetsky-Shapiro *ps*
  - Relative Gain *relgain*
  - Weighted Relative Accuracy *wracc*
  


### 2.1. Definició de la mètrica pròpia

S'ha emprat la mètrica *** 
```{r}
metrica_significacio <- function (df_crims, df_regles, target){
  llista_target_values = unique(df_crims[,target])
  for (regla_i in 1:nrow(df_regles)){
    for (target_value_i in 1:nrow(llista_target_values)){
      
    }
  }
}
```

```{r}
n_condicions <- function (df_crims, regles){
  n = 0
  for (fila_i in nrow(df_crims)){
    fila = df_crims[fila_i,]
    
    for (condicions in regles){
      tot_true = TRUE
      for (condicio in condicions){
        print(as.character(fila[1, condicio[1]]))
        print(condicio)
        print("")
        if (as.character(fila[1, condicio[1]]) != condicio[2]){
          tot_true = FALSE
          break
        }
      }
      if (tot_true) {
        n = n + 1
      }
    }
  }
}

n_condicions(mostra, data.frame(list(c("Crim", "110"), 
                                  c("Hora", "0 - 4"))))
```

```{r}
a = list(list("Crim", "110"), 
     list("Hora", "0 - 4"))

for (i in 1:length(a)){
  print(i)
  print (a[i][1])
  print (a[i][2])
  print("")
}
```


### 2.2. Cerca de subgrups, emprant diferents mètodes i mètriques

Emprarem una mostra del dataframe per fer proves:
```{r}
set.seed(777)
mostra = crims[sample(nrow(crims), 20000, replace = FALSE),]
```

#### Cerca #1
Objectiu: Crim concret, robatori de cotxe, amb totes les columnes.
```{r}
DiscoverSubgroups(mostra, as.target("Crim", "330"), as.df = TRUE)
```
Conclusions: En general, si no s'ha emprat arma és un bon criteri per veure si s'ha produït un robatori de cotxe, ja que apareix a les principals regles trobades. És interessant apreciar que un 10% dels crims sense armes siguin aquest crim.

#### Cerca #2
Objectiu: veure si l'àrea i l'hora afecten al crim comès. Concretament, al robatori de cotxes, que és el més comú.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Crim", "330"), new ("SDTaskConfig", attributes=c("Area", "Hora"), method="bsd", qf="lift", minsize=500), as.df = TRUE)
```
Conclusions: veim que un 11% dels delictes comesos a l'àrea central són robatoris de cotxes, i entre les vuit i les dotze de la nit el percentatge de robatoris de cotxes (en comparació a la resta de crims) és prou elevat: 10%.

#### Cerca #3
Objectiu: veure en quins casos s'ha empresonat al culpable.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Estat", "AA"), new ("SDTaskConfig", attributes=NULL), as.df = TRUE)
```
Conclusions: en un 14% dels casos en què s'ha reportat el crim el mateix dia que s'ha produït, es troba al culpable.

#### Cerca #4
Objectiu: Veure quan és que es tarda entre un mes i un any en reportar el crim, respecte a quan es produeix.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Dif.Oc.Rep", "1 year"), new ("SDTaskConfig", attributes=NULL), as.df = TRUE)
```
Veim, pels resultats obtinguts, que una quarta part dels robatoris d'identitat (crim nº 354) són reportats entre un mes i un any després d'haver sigut comesos. També es pot apreciar que el fet de no conèixer l'arma és indicatiu de que es tardarà més en reportar el crim.

#### Cerca #5
Objectiu: observar si el primer crim comès i l'arma emprada afecten al segon crim comès.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Crim.2", "998"), new ("SDTaskConfig", attributes=c("Crim", "Arma"), method="beam", qf="relgain", minsize=500), as.df = TRUE)
```
Conclusions: els crims 210 (robatori), 230 (assalt amb arma letal), 310 (robatori a una casa), van molt probablement seguits del crim 998. D'aquest crim no en tenim la descripció, degut a que mai apareix com a primer crim al dataframe del que disposam. Tot i que hem intentat trobar-ho a la pàgina oficial, no hem trobat cap recopilació de codis de crims amb la seva descripció.

#### Cerca #6
Objectiu: veure que contribueix a que el crim sigui de vesprada (entre les dotze i les quatre de la matinada).
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Hora", "0 - 4"), new ("SDTaskConfig", attributes=c("Dia.Setmana", "Vict.Edat", "Vict.Sexe", "Vict.Descent", "Dif.Oc.Rep", "Arma")), as.df = TRUE)
```
D'entre els crims que es reporten el mateix dia, un 16% es produeixen entre les dotze i les quatre de la matinada. A més veim també que entre les regles apareixen, tot i que en una quantitat menor de dades, els dissabtes i diumenges com a dies de la setmana com a dies en què un més alt percentatge de crims a aquesta hora es produeixen. 

De l'edat de la víctima es descarta la franja d'edat d'entre 0 i deu anys, que s'associa a una mala introducció de les dades, i ens podem quedar amb què si l'edat és de 20 a 30 anys, la probabilitat que es produeixi el crim a aquestes hores és més elevada.

Per tant, traguent conclusions una mica abans d'hora, pareix que els joves de festa els caps de setmana són els que sofreixen més crims a aquestes hores. 

#### Cerca #7
Objectiu: veure què influeix més a l'hora que un crim es produeixi en una àrea concreta de la ciutat, concretament, a l'àrea Central. En aquest cas, deixam dues execucions diferentes del mètode DiscoverSubgroups, degut a que hem obtingut resultats molt diferents sols canviant la mètrica:
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Area", "Central"), new ("SDTaskConfig", attributes=NULL, method="sdmap", qf="chi2", minsize=500), as.df = TRUE)
```

Conclusions: les principals conclusions que en podem extreure emprant la mètrica chi2 són que si el delicte es comet a la vorera, es reporta el mateix dia o no es troba al culpable, la probabilitat que el crim es produeixi a l'àrea central és d'aproximadament un vint percent.

```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Area", "Central"), new ("SDTaskConfig", attributes=NULL, method="sdmap", qf="ps", minsize=500), as.df = TRUE)
```

Conclusions: emprant la mètrica per defecte, el vuit percent de crims on la víctima és un home, s'han produït a l'àrea central. També l'11 percent dels delictes on la víctima és de color, es produeixen en aquesta àrea. També trobam la regla sobre la vorera, que ja hem trobat emprant l'altra mètrica.

En cap dels dos casos, els resultats obtinguts són molt concloents sobre quines regles ens permeten predir l'àrea on s'ha comès el delicte, ja que sols s'obtenen valors bastant genèrics per al sexe, la raça o el lloc del crim.

#### Cerca #8
Objectiu: observar els factors que més afecten per a que un crim es produeixi al carrer.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Lloc", "STREET"), new ("SDTaskConfig", attributes=NULL), as.df = TRUE)
```
Conclusions: pareix que el fet que no es gaudeixi de molta informació respecte del crim, com ara que no es sapi l'edat, el sexe o l'ascendència de la víctima o l'arma emprada, és un gran indicatiu de que s'hagi produït al carrer.

Pensam que aquesta descripció és característica de crims on realment no hi ha cap víctima concreta, com actes de vandalisme cap a mobiliari urbà, que es solen produir al carrer.

#### Cerca #9
Objectiu: comprovar si es pot determinar que el crim és una violació (codi 121), a partir de característiques com l'arma emprada, l'hora, l'edat de la víctima, etc.
```{r, time_it=TRUE}
DiscoverSubgroups(mostra, as.target("Crim", "121"), new ("SDTaskConfig", attributes=c("Vict.Sexe", "Vict.Edat", "Dif.Oc.Rep", "Arma", "Dia.Setmana", "Hora")), as.df = TRUE)
```
Conclusions: els valors que apareixen a més regles són: la força física com a arma, que la víctima sigui femella, que el cas no estigui resolt (estat IC) i que s'hagi tardat entre un dia i una setmana a reportar el crim.

Veim que aquestes dades són prou lògiques si ens aturam a pensar-les. Tot i així, els percentatges són prou baixos com per treure resultats concloents. Això és degut a que hi ha molta varietat de crims que cumpleixen aquesta classe d'antecedents.


## 3. Conclusions finals